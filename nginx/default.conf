# -----------------------------------------------------------------
# 1) Cache zone for static files
# -----------------------------------------------------------------
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=STATIC:10m inactive=7d use_temp_path=off;

# -----------------------------------------------------------------
# 2) Upstream pointing at your Next.js container
# -----------------------------------------------------------------
upstream nextjs {
    server nextjs:3000;
}

# -----------------------------------------------------------------
# 3) HTTP â†’ HTTPS Redirect
# -----------------------------------------------------------------
server {
    listen       80 default_server;
    server_name  fynopsis.ai www.fynopsis.ai;

    # Redirect every request to HTTPS
    return 301 https://$host$request_uri;
}

# -----------------------------------------------------------------
# 4) HTTPS Server Block
# -----------------------------------------------------------------
server {
    listen              443 ssl http2 default_server;
    server_name         fynopsis.ai www.fynopsis.ai;
    server_tokens       off;

    # Point at your installed cert & key
    ssl_certificate     /etc/nginx/certs/origin.crt;
    ssl_certificate_key /etc/nginx/certs/origin.key;

    # Optional TLS hardening
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers         HIGH:!aNULL:!MD5;

    # Gzip + WebSocket headers
    gzip                on;
    gzip_proxied        any;
    gzip_comp_level     4;
    gzip_types          text/css application/javascript image/svg+xml;

    proxy_http_version  1.1;
    proxy_set_header    Upgrade $http_upgrade;
    proxy_set_header    Connection "upgrade";
    proxy_set_header    Host       $host;
    proxy_cache_bypass  $http_upgrade;

    # BUILT ASSETS (JS bundles)
    location /_next/static {
        proxy_cache STATIC;
        proxy_pass   http://nextjs;
    }

    # STATIC ASSETS (images, etc)
    location /static {
        proxy_cache          STATIC;
        proxy_ignore_headers Cache-Control;
        proxy_cache_valid    60m;
        proxy_pass            http://nextjs;
    }

    # DYNAMIC / HTML routes
    location / {
        proxy_pass http://nextjs;
    }
}